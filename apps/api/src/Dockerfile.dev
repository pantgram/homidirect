# Use a specific Node.js version based on your project's `engines` requirement in package.json
FROM node:20-alpine

# Set the working directory in the container
WORKDIR /app

# Set environment variables
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NODE_ENV=development

# Install pnpm
# Using the version specified in your root package.json
RUN corepack enable && corepack prepare pnpm@8.15.0 --activate

# Copy the dependency manifests for the entire monorepo
# This is done to leverage Docker's layer caching.
# Dependencies are only re-installed when these files change.
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy the package.json files for all workspaces
# This is a common pattern for pnpm monorepos.
COPY apps/api/package.json ./apps/api/
COPY apps/landing/package.json ./apps/landing/
COPY apps/web/package.json ./apps/web/
COPY packages/config/package.json ./packages/config/
COPY packages/shared/package.json ./packages/shared/

# Install all dependencies for the entire monorepo
# We don't use --prod because this is a development Dockerfile
# and we need devDependencies like tsx.
RUN pnpm install

# Copy the rest of the source code
# This will be mounted over by the docker-compose volume for development,
# but it's good practice to have it in the image for standalone runs.
COPY . .

# Expose the port the API runs on
# This is defined in apps/api/src/config/env.ts
EXPOSE 3000

# The command to run the API in development mode with hot-reloading.
# This corresponds to the "dev:api" script in your root package.json
CMD ["pnpm", "dev:api"]